<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>code-along</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="slides_codealong_files/libs/clipboard/clipboard.min.js"></script>
<script src="slides_codealong_files/libs/quarto-html/quarto.js"></script>
<script src="slides_codealong_files/libs/quarto-html/popper.min.js"></script>
<script src="slides_codealong_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="slides_codealong_files/libs/quarto-html/anchor.min.js"></script>
<link href="slides_codealong_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="slides_codealong_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="slides_codealong_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="slides_codealong_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="slides_codealong_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">code-along</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="example-dataset-a-brief-overview" class="level2">
<h2 class="anchored" data-anchor-id="example-dataset-a-brief-overview">Example Dataset: A Brief Overview</h2>
<p>We’ll explore the relationship between physical activity and pulse in the National Health and Nutrition Examination Survey (NHANES) dataset, which has been modified for this course with simulated variables.</p>
<p>To try this out in practice, we load the NHANES dataset, only keep the variables we need for the example.</p>
<p>The variables used in the dataset:</p>
<ul>
<li><p>exposure of interest (a): physical activity (continuous variable)</p></li>
<li><p>outcome (y): Pulse (continuous variable)</p></li>
<li><p>mediator (m): BMI (continuous variable)</p></li>
</ul>
<p>Note that the example is created to demonstrate the methods, and there is no clinical relevance of the results. For the convenience of analysis, we have transformed the mediator (m) and outcome variable (y) so that they follow a normal distribution.</p>
<p>Four demographic variables are considered in the analysis: age, gender, education, and smoking. We assume that adjusting for these four confounding is sufficient to block the backdoor paths.</p>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the library</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load the data </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>nhanes <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/NHANES.csv"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 10000 Columns: 76
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (31): SurveyYr, Gender, AgeDecade, Race1, Race3, Education, MaritalStatu...
dbl (45): ID, Age, AgeMonths, HHIncomeMid, Poverty, HomeRooms, Weight, Lengt...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Vedhæfter pakke: 'dplyr'

De følgende objekter er maskerede fra 'package:stats':

    filter, lag

De følgende objekter er maskerede fra 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># keep the variables used in the analyses </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> nhanes <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(ID, <span class="at">w1 =</span> Age, <span class="at">w2 =</span> Gender, <span class="at">w3 =</span> Education, <span class="at">w4 =</span> Smoke100, <span class="at">a =</span> PhysActive, <span class="at">m =</span> BMI, <span class="at">y =</span> Pulse, <span class="at">y2 =</span> Diabetes ) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="continuous-outcome" class="level2">
<h2 class="anchored" data-anchor-id="continuous-outcome">Continuous outcome</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Physical activity is a binary variable, dichotomized as 'Yes' or 'No'. </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data<span class="sc">$</span>a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  No  Yes 
3260 3656 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check the distribution of outcome </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  40.00   64.00   72.00   72.45   80.00  136.00 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(data<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slides_codealong_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check the distribution of mediation</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data<span class="sc">$</span>m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  15.02   24.10   27.80   28.80   32.22   81.25 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(data<span class="sc">$</span>m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="slides_codealong_files/figure-html/unnamed-chunk-2-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check the education categories and relevel </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data<span class="sc">$</span>w3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     8th Grade 9 - 11th Grade   College Grad    High School   Some College 
           417            858           2028           1447           2166 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>w3 <span class="ot">&lt;-</span> <span class="fu">relevel</span>(<span class="fu">factor</span>(data<span class="sc">$</span>w3), <span class="at">ref =</span> <span class="st">"College Grad"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>i) run a model for the mediator only adjusting for confouding factors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>lm_m <span class="ot">&lt;-</span> <span class="fu">lm</span>(m <span class="sc">~</span> a <span class="sc">+</span> w1 <span class="sc">+</span> w2 <span class="sc">+</span> w3 <span class="sc">+</span> w4, <span class="at">data =</span> data)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = m ~ a + w1 + w2 + w3 + w4, data = data)

Residuals:
    Min      1Q  Median      3Q     Max 
-15.624  -4.526  -1.104   3.431  50.612 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      28.467603   0.323923  87.884  &lt; 2e-16 ***
aYes             -1.643518   0.170461  -9.642  &lt; 2e-16 ***
w1                0.012135   0.004819   2.518 0.011827 *  
w2male            0.274867   0.160396   1.714 0.086633 .  
w38th Grade       1.271955   0.365283   3.482 0.000501 ***
w39 - 11th Grade  1.084541   0.281211   3.857 0.000116 ***
w3High School     1.538987   0.234533   6.562 5.70e-11 ***
w3Some College    1.381674   0.207826   6.648 3.19e-11 ***
w4Yes            -1.056643   0.163957  -6.445 1.24e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6.586 on 6907 degrees of freedom
Multiple R-squared:  0.0338,    Adjusted R-squared:  0.03268 
F-statistic:  30.2 on 8 and 6907 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>We see that physical activity (a) is associated with lower BMI.</p>
<p>ii) run the model for the outcome, including an interaction term between exposure and mediator.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>lm_y <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> a <span class="sc">+</span> m <span class="sc">+</span> a<span class="sc">:</span>m <span class="sc">+</span> w1 <span class="sc">+</span> w2 <span class="sc">+</span> w3 <span class="sc">+</span> w4, <span class="at">data =</span> data)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ a + m + a:m + w1 + w2 + w3 + w4, data = data)

Residuals:
    Min      1Q  Median      3Q     Max 
-33.602  -8.101  -0.904   6.984  72.204 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      75.480620   0.992520  76.050  &lt; 2e-16 ***
aYes             -5.505909   1.242754  -4.430 9.55e-06 ***
m                 0.141694   0.027819   5.093 3.61e-07 ***
w1               -0.126874   0.008372 -15.155  &lt; 2e-16 ***
w2male           -3.767879   0.278790 -13.515  &lt; 2e-16 ***
w38th Grade       0.395513   0.635041   0.623 0.533427    
w39 - 11th Grade  2.069824   0.488942   4.233 2.33e-05 ***
w3High School     0.842950   0.408777   2.062 0.039233 *  
w3Some College    1.327753   0.362432   3.663 0.000251 ***
w4Yes             1.531263   0.285538   5.363 8.46e-08 ***
aYes:m            0.141774   0.041893   3.384 0.000718 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 11.44 on 6905 degrees of freedom
Multiple R-squared:  0.07691,   Adjusted R-squared:  0.07558 
F-statistic: 57.53 on 10 and 6905 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>In this model we can see:</p>
<ul>
<li><p>physical activity reduces pulse rate, independent of BMI (m);</p></li>
<li><p>BMI is positively associated with pulse rate (y);</p></li>
<li><p>There is interaction between physical activity (a) and BMI (m)</p>
<h3 id="we-will-use-the-cmaverse-r-package-to-conduct-the-mediation-analyses." class="anchored">We will use the CMAverse R package to conduct the mediation analyses.</h3></li>
</ul>
<p>First, we load the package and then we setup the model object. We have to specify:</p>
<ul>
<li><p>model: this is the type of model, or the approach for the causal mediation. We used the regression-based approach, so we will also do that here. However, one can also use weighting-based approach marginal structural models or the gformula.</p></li>
<li><p>outcome: your outcome variable</p></li>
<li><p>exposure: your exposure/intervention/treatment</p></li>
<li><p>mediator: your mediator</p></li>
<li><p>mreg: the type of model for the mediator. It is a list because you can have multiple mediators</p></li>
<li><p>yreg: type of regression for the outcome. E.g., linear, logistic, cox.</p></li>
<li><p>astar: Control/comparison intervention (value from)</p></li>
<li><p>a: Intervention (value to)</p></li>
<li><p>mval: the value for the mediator when estimating the CDE</p></li>
<li><p>EMin0t: indicator of whether there should be exposure and mediator interaction in the models.</p></li>
<li><p>estimation: method for estimating causal effects. Can use parametric functions or imputation.</p></li>
<li><p>inference: how to calculate confidence intervals. For regression-based we use the delta method. But for the other methods we use a bootstrap.</p></li>
</ul>
<p>Load the library:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## install.packages("CMAverse")  #reinstall the package if the library is not loaded</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CMAverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Build the models:</p>
<ul>
<li><p>Since both the mediator(BMI) and outcome(pulse rate) are continuous, we use linear regression models.</p></li>
<li><p>Note EMint: we specify it as TRUE, to add interaction term</p></li>
<li><p>We set mediator values to 25, suppose mediator could be intervened to normal weight</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>res_rb <span class="ot">&lt;-</span> <span class="fu">cmest</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data, <span class="at">model =</span> <span class="st">"rb"</span>, <span class="at">outcome =</span> <span class="st">"y"</span>, <span class="at">exposure =</span> <span class="st">"a"</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mediator =</span> <span class="st">"m"</span>, <span class="at">basec =</span> <span class="fu">c</span>(<span class="st">"w1"</span>,<span class="st">"w2"</span>,<span class="st">"w3"</span>,<span class="st">"w4"</span>), <span class="at">EMint =</span> <span class="cn">TRUE</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mreg =</span> <span class="fu">list</span>(<span class="st">"linear"</span>), <span class="at">yreg =</span> <span class="st">"linear"</span>, <span class="co">#specifiy model types</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">astar =</span> <span class="dv">0</span>, <span class="at">a =</span> <span class="dv">1</span>, <span class="at">mval =</span> <span class="fu">list</span>(<span class="dv">25</span>),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimation =</span> <span class="st">"paramfunc"</span>, <span class="at">inference =</span> <span class="st">"delta"</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in estinf(): a is not a value of the exposure; Yes is used</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in estinf(): astar is not a value of the exposure; No is used</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res_rb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Causal Mediation Analysis

# Outcome regression:

Call:
glm(formula = y ~ a + m + a * m + w1 + w2 + w3 + w4, family = gaussian(), 
    data = getCall(x$reg.output$yreg)$data, weights = getCall(x$reg.output$yreg)$weights)

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      75.480620   0.992520  76.050  &lt; 2e-16 ***
aYes             -5.505909   1.242754  -4.430 9.55e-06 ***
m                 0.141694   0.027819   5.093 3.61e-07 ***
w1               -0.126874   0.008372 -15.155  &lt; 2e-16 ***
w2male           -3.767879   0.278790 -13.515  &lt; 2e-16 ***
w38th Grade       0.395513   0.635041   0.623 0.533427    
w39 - 11th Grade  2.069824   0.488942   4.233 2.33e-05 ***
w3High School     0.842950   0.408777   2.062 0.039233 *  
w3Some College    1.327753   0.362432   3.663 0.000251 ***
w4Yes             1.531263   0.285538   5.363 8.46e-08 ***
aYes:m            0.141774   0.041893   3.384 0.000718 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 130.7631)

    Null deviance: 978151  on 6915  degrees of freedom
Residual deviance: 902919  on 6905  degrees of freedom
AIC: 53344

Number of Fisher Scoring iterations: 2


# Mediator regressions: 

Call:
glm(formula = m ~ a + w1 + w2 + w3 + w4, family = gaussian(), 
    data = getCall(x$reg.output$mreg[[1L]])$data, weights = getCall(x$reg.output$mreg[[1L]])$weights)

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      28.467603   0.323923  87.884  &lt; 2e-16 ***
aYes             -1.643518   0.170461  -9.642  &lt; 2e-16 ***
w1                0.012135   0.004819   2.518 0.011827 *  
w2male            0.274867   0.160396   1.714 0.086633 .  
w38th Grade       1.271955   0.365283   3.482 0.000501 ***
w39 - 11th Grade  1.084541   0.281211   3.857 0.000116 ***
w3High School     1.538987   0.234533   6.562 5.70e-11 ***
w3Some College    1.381674   0.207826   6.648 3.19e-11 ***
w4Yes            -1.056643   0.163957  -6.445 1.24e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 43.3789)

    Null deviance: 310099  on 6915  degrees of freedom
Residual deviance: 299618  on 6907  degrees of freedom
AIC: 45711

Number of Fisher Scoring iterations: 2


# Effect decomposition on the mean difference scale via the regression-based approach
 
Closed-form parameter function estimation with 
 delta method standard errors, confidence intervals and p-values 
 
             Estimate Std.error  95% CIL 95% CIU    P.val    
cde          -1.96156   0.33780 -2.62362  -1.299 6.36e-09 ***
pnde         -1.29952   0.30064 -1.88877  -0.710 1.54e-05 ***
tnde         -1.53252   0.30012 -2.12076  -0.944 3.29e-07 ***
pnie         -0.23288   0.05171 -0.33422  -0.132 6.68e-06 ***
tnie         -0.46588   0.07077 -0.60459  -0.327 4.61e-11 ***
te           -1.76540   0.29830 -2.35006  -1.181 3.26e-09 ***
intref        0.66204   0.19637  0.27717   1.047 0.000748 ***
intmed       -0.23301   0.07297 -0.37603  -0.090 0.001407 ** 
cde(prop)     1.11111   0.09569  0.92356   1.299  &lt; 2e-16 ***
intref(prop) -0.37501   0.12730 -0.62451  -0.126 0.003220 ** 
intmed(prop)  0.13199   0.04605  0.04174   0.222 0.004152 ** 
pnie(prop)    0.13191   0.03588  0.06158   0.202 0.000237 ***
pm            0.26390   0.05736  0.15148   0.376 4.21e-06 ***
int          -0.24302   0.08345 -0.40659  -0.079 0.003590 ** 
pe           -0.11111   0.09569 -0.29866   0.076 0.245582    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(cde: controlled direct effect; pnde: pure natural direct effect; tnde: total natural direct effect; pnie: pure natural indirect effect; tnie: total natural indirect effect; te: total effect; intref: reference interaction; intmed: mediated interaction; cde(prop): proportion cde; intref(prop): proportion intref; intmed(prop): proportion intmed; pnie(prop): proportion pnie; pm: overall proportion mediated; int: overall proportion attributable to interaction; pe: overall proportion eliminated)

Relevant variable values: 
$a
[1] "Yes"

$astar
[1] "No"

$mval
$mval[[1]]
[1] 25


$basecval
$basecval[[1]]
[1] 47.17467

$basecval[[2]]
[1] 0.4939271

$basecval[[3]]
[1] 0.06029497 0.12406015 0.20922499 0.31318681

$basecval[[4]]
[1] 0.4467901</code></pre>
</div>
</div>
</section>
<section id="binary-outcome" class="level2">
<h2 class="anchored" data-anchor-id="binary-outcome">Binary outcome</h2>
<p>Suppose now i am interested in how physical activity influences the risk of diabetes. I will first check the proportion of diabetes in the sample.</p>
<pre class="{# y2 is diaebtes}"><code>table(data$y2)</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># recode diabetes to 1(Yes) and 0(No)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>y2 <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>y2 <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>y2 <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>res_rb <span class="ot">&lt;-</span> <span class="fu">cmest</span>( <span class="at">data =</span> data, <span class="at">model =</span> <span class="st">"rb"</span>, <span class="at">outcome =</span> <span class="st">"y2"</span>, <span class="at">exposure =</span> <span class="st">"a"</span>, <span class="at">mediator =</span> <span class="st">"m"</span>, <span class="at">basec =</span> <span class="fu">c</span>(<span class="st">"w1"</span>,<span class="st">"w2"</span>,<span class="st">"w3"</span>,<span class="st">"w4"</span>), <span class="at">EMint =</span> <span class="cn">TRUE</span>, </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="at">mreg =</span> <span class="fu">list</span>(<span class="st">"linear"</span>), </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="at">yreg =</span> <span class="st">"logistic"</span>,  <span class="at">mval =</span> <span class="fu">list</span>(<span class="dv">25</span>), <span class="at">estimation =</span> <span class="st">"paramfunc"</span>, <span class="at">inference =</span> <span class="st">"delta"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in regrun(): When estimation is 'paramfunc' and yreg is 'logistic' or
'coxph', the outcome must be rare; ignore this warning if the outcome is rare</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in estinf(): a is not a value of the exposure; Yes is used</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in estinf(): astar is not a value of the exposure; No is used</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in estinf(): yval is not specified; 1 is used</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res_rb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Causal Mediation Analysis

# Outcome regression:

Call:
glm(formula = y2 ~ a + m + a * m + w1 + w2 + w3 + w4, family = binomial(), 
    data = getCall(x$reg.output$yreg)$data, weights = getCall(x$reg.output$yreg)$weights)

Coefficients:
                  Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)      -8.374413   0.346489 -24.169  &lt; 2e-16 ***
aYes             -0.634379   0.389138  -1.630    0.103    
m                 0.090595   0.007290  12.427  &lt; 2e-16 ***
w1                0.057348   0.002904  19.747  &lt; 2e-16 ***
w2male            0.377304   0.087929   4.291 1.78e-05 ***
w38th Grade       0.816055   0.161519   5.052 4.36e-07 ***
w39 - 11th Grade  0.204796   0.153228   1.337    0.181    
w3High School     0.192272   0.131714   1.460    0.144    
w3Some College    0.256072   0.121479   2.108    0.035 *  
w4Yes             0.107626   0.087610   1.228    0.219    
aYes:m            0.016244   0.012001   1.354    0.176    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4611.5  on 6915  degrees of freedom
Residual deviance: 3794.1  on 6905  degrees of freedom
AIC: 3816.1

Number of Fisher Scoring iterations: 6


# Mediator regressions: 

Call:
glm(formula = m ~ a + w1 + w2 + w3 + w4, family = gaussian(), 
    data = getCall(x$reg.output$mreg[[1L]])$data, weights = getCall(x$reg.output$mreg[[1L]])$weights)

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      28.467603   0.323923  87.884  &lt; 2e-16 ***
aYes             -1.643518   0.170461  -9.642  &lt; 2e-16 ***
w1                0.012135   0.004819   2.518 0.011827 *  
w2male            0.274867   0.160396   1.714 0.086633 .  
w38th Grade       1.271955   0.365283   3.482 0.000501 ***
w39 - 11th Grade  1.084541   0.281211   3.857 0.000116 ***
w3High School     1.538987   0.234533   6.562 5.70e-11 ***
w3Some College    1.381674   0.207826   6.648 3.19e-11 ***
w4Yes            -1.056643   0.163957  -6.445 1.24e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 43.3789)

    Null deviance: 310099  on 6915  degrees of freedom
Residual deviance: 299618  on 6907  degrees of freedom
AIC: 45711

Number of Fisher Scoring iterations: 2


# Effect decomposition on the odds ratio scale via the regression-based approach
 
Closed-form parameter function estimation with 
 delta method standard errors, confidence intervals and p-values 
 
                Estimate Std.error   95% CIL 95% CIU    P.val    
Rcde            0.795897  0.096472  0.627598   1.009  0.05965 .  
Rpnde           0.920467  0.090612  0.758954   1.116  0.39987    
Rtnde           0.896219  0.084372  0.745213   1.078  0.24447    
Rpnie           0.861660  0.016842  0.829275   0.895 2.58e-14 ***
Rtnie           0.838961  0.020430  0.799859   0.880 5.57e-13 ***
Rte             0.772236  0.073851  0.640246   0.931  0.00688 ** 
ERcde          -0.111895  0.017613 -0.146417  -0.077 2.11e-10 ***
ERintref        0.032362  0.081066 -0.126525   0.191  0.68974    
ERintmed       -0.009891  0.024631 -0.058168   0.038  0.68799    
ERpnie         -0.138340  0.016842 -0.171349  -0.105 2.22e-16 ***
ERcde(prop)     0.491276  0.289946 -0.077008   1.060  0.09019 .  
ERintref(prop) -0.142088  0.136734 -0.410081   0.126  0.29873    
ERintmed(prop)  0.043428  0.118270 -0.188378   0.275  0.71347    
ERpnie(prop)    0.607383  0.197668  0.219961   0.995  0.00212 ** 
pm              0.650811  0.289486  0.083430   1.218  0.02457 *  
int            -0.098659  0.134584 -0.362439   0.165  0.46352    
pe              0.508724  0.289946 -0.059560   1.077  0.07934 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Rcde: controlled direct effect odds ratio; Rpnde: pure natural direct effect odds ratio; Rtnde: total natural direct effect odds ratio; Rpnie: pure natural indirect effect odds ratio; Rtnie: total natural indirect effect odds ratio; Rte: total effect odds ratio; ERcde: excess relative risk due to controlled direct effect; ERintref: excess relative risk due to reference interaction; ERintmed: excess relative risk due to mediated interaction; ERpnie: excess relative risk due to pure natural indirect effect; ERcde(prop): proportion ERcde; ERintref(prop): proportion ERintref; ERintmed(prop): proportion ERintmed; ERpnie(prop): proportion ERpnie; pm: overall proportion mediated; int: overall proportion attributable to interaction; pe: overall proportion eliminated)

Relevant variable values: 
$a
[1] "Yes"

$astar
[1] "No"

$yval
[1] "1"

$mval
$mval[[1]]
[1] 25


$basecval
$basecval[[1]]
[1] 47.17467

$basecval[[2]]
[1] 0.4939271

$basecval[[3]]
[1] 0.06029497 0.12406015 0.20922499 0.31318681

$basecval[[4]]
[1] 0.4467901</code></pre>
</div>
</div>
<p>We can see that a great proportion of the effect of physical activity on diabetes risk is mediated through BMI (65%). undefinedThe remaining ~35% would represent physical activity’s direct effect on diabetes risk through other pathways</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>